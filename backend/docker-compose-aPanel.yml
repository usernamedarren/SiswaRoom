version: '3.8'

# Docker Compose untuk aPanel Production Deployment
# Menggunakan MySQL yang sudah ada di aPanel (mysql_siswaroom-mysql_siswaroom-1)
# Dan phpMyAdmin yang sudah ada (phpmyadmin_siswaroom-phpmyadmin_siswaroom-1)

services:
  # Backend Node.js Service - Terhubung ke MySQL aPanel yang sudah ada
  siswaroom-backend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - NODE_ENV=production
    container_name: siswaroom-backend-prod
    restart: always
    ports:
      - "4001:4000"  # Expose ke host pada port 4001
    environment:
      # Terhubung ke MySQL aPanel yang existing
      DB_HOST: localhost
      DB_PORT: 13306  # Port exposed dari container mysql_siswaroom
      DB_USER: root
      DB_PASSWORD: admin
      DB_NAME: siswaroom
      JWT_SECRET: supersecretjwt_prod_change_this
      JWT_EXPIRE: 7d
      NODE_ENV: production
      API_URL: http://192.168.4.247:4001
      CORS_ORIGIN: "http://192.168.4.247:8088,http://siswaroom.online,https://siswaroom.online,http://api.siswaroom.online,https://api.siswaroom.online"
    networks:
      - host  # Gunakan host network untuk akses ke MySQL aPanel
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/api/subjects"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 45s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Frontend Service - Menggunakan nginx untuk serve static files
  siswaroom-frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=http://192.168.4.247:4001/api
    container_name: siswaroom-frontend-prod
    restart: always
    ports:
      - "8089:80"  # Expose ke host pada port 8089 (8088 sudah dipakai siswaroom-web)
    environment:
      NGINX_HOST: siswaroom.online
      NGINX_PORT: 80
    networks:
      - host
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  host:
    name: host
    driver: host

# Note: MySQL dan phpMyAdmin sudah berjalan sebagai container terpisah:
# - mysql_siswaroom-mysql_siswaroom-1 (port 13306)
# - phpmyadmin_siswaroom-phpmyadmin_siswaroom-1 (port 8080)
